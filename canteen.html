<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Canteen Management System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore,collection,addDoc,getDocs,deleteDoc,doc,updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyA0MilQXBxRH3bK2XwBl8of1PIFpDx8K14",
  authDomain:"managment-5ecda.firebaseapp.com",
  projectId:"managment-5ecda"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let UID="",currentCustomerID="",currentCustomerName="";

onAuthStateChanged(auth,u=>{
  if(!u) location.href="login.html";
  UID=u.uid;
  mainPage.style.display="block";
  loadCustomers();
});

window.logout=()=>signOut(auth).then(()=>location.href="login.html");

/* ================= CUSTOMERS ================= */
window.addCustomer=async()=>{
  if(!custName.value||!custNumber.value) return alert("Fill details");
  await addDoc(collection(db,"users",UID,"customers"),{
    name:custName.value,number:custNumber.value,created:Date.now()
  });
  custName.value="";custNumber.value="";
  loadCustomers();
};

async function loadCustomers(){
  customerList.innerHTML="";
  const snap=await getDocs(collection(db,"users",UID,"customers"));
  let i=1;
  snap.forEach(d=>{
    const c=d.data();
    customerList.innerHTML+=`
    <div class="customerCard">
      <span>${i++}. ${c.name} (${c.number})</span>
      <div class="rightBtns">
        <button onclick="openCustomer('${d.id}','${c.name}')">Open</button>
        <button onclick="editCustomer('${d.id}','${c.name}','${c.number}')">Edit</button>
        <button onclick="deleteCustomer('${d.id}')">Delete</button>
      </div>
    </div>`;
  });
}

window.searchCustomer=()=>{
  const v=searchInput.value.toLowerCase();
  document.querySelectorAll(".customerCard").forEach(c=>{
    c.style.display=c.innerText.toLowerCase().includes(v)?"flex":"none";
  });
};

window.editCustomer=(id,n,m)=>{
  const nn=prompt("Name",n);
  const nm=prompt("Mobile",m);
  if(!nn||!nm) return;
  updateDoc(doc(db,"users",UID,"customers",id),{name:nn,number:nm}).then(loadCustomers);
};

window.deleteCustomer=async(id)=>{
  if(!confirm("Delete customer?")) return;
  await deleteDoc(doc(db,"users",UID,"customers",id));
  loadCustomers();
};

/* ================= ORDERS ================= */
window.openCustomer=(id,name)=>{
  currentCustomerID=id;
  currentCustomerName=name;
  customerList.style.display="none";
  customerSection.classList.remove("hidden");
  customerTitle.innerText=name;
  setToday();
  showOrders();
};

window.backToCustomers=()=>{
  customerSection.classList.add("hidden");
  customerList.style.display="block";
};

function setToday(){
  const d=new Date();
  orderDate.value=
    String(d.getDate()).padStart(2,"0")+"-"+
    String(d.getMonth()+1).padStart(2,"0")+"-"+d.getFullYear();
}

window.addOrder=async()=>{
  let rate=0,item=itemType.value;

  if(item==="tea") rate=5;
  else if(item==="snack") rate=15;
  else if(item==="lunch") rate=45;
  else if(item==="dinner") rate=45;
  else{
    if(!otherName.value || !otherRate.value){
      alert("Other item name aur rate dalo");
      return;
    }
    item=otherName.value;
    rate=parseInt(otherRate.value);
  }

  await addDoc(collection(db,"users",UID,"orders",currentCustomerID,"items"),{
    date:orderDate.value,
    item,
    qty:+qty.value,
    rate,
    total:qty.value*rate,
    status:statusType.value
  });

  qty.value="";otherName.value="";otherRate.value="";
  showOrders();
};

async function showOrders(){
  orderList.innerHTML="";
  let due=0,paid=0,parchi=0;

  const snap=await getDocs(collection(db,"users",UID,"orders",currentCustomerID,"items"));
  snap.forEach(d=>{
    const o=d.data();
    if(o.status==="due") due+=o.total;
    if(o.status==="paid") paid+=o.total;
    if(o.status==="parchi") parchi+=o.total;

    orderList.innerHTML+=`
    <tr>
      <td>${o.date}</td>
      <td>${o.item}</td>
      <td>${o.qty}</td>
      <td>${o.rate}</td>
      <td>${o.total}</td>
      <td>${o.status}</td>
      <td><button onclick="deleteOrder('${d.id}')">X</button></td>
    </tr>`;
  });

  totalDue.innerText=due;
  totalPaid.innerText=paid;
  totalParchi.innerText=parchi;
  grandTotal.innerText=due+paid+parchi;
}

window.deleteOrder=async(id)=>{
  await deleteDoc(doc(db,"users",UID,"orders",currentCustomerID,"items",id));
  showOrders();
};

window.printBill=()=>{
  let w=window.open("");
  w.document.write(`<h2>Bill - ${currentCustomerName}</h2>`+
    document.querySelector("table").outerHTML);
  w.print();w.close();
};

window.downloadMonthlyCSV=()=>{
  let csv="Date,Item,Qty,Rate,Total,Status\n";
  document.querySelectorAll("#orderList tr").forEach(r=>{
    const t=[...r.children].map(td=>td.innerText);
    csv+=`${t[0]},${t[1]},${t[2]},${t[3]},${t[4]},${t[5]}\n`;
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download=currentCustomerName+"_Report.csv";
  a.click();
};
window.downloadAllCustomersExcel = async () => {
  let csv = "Customer Name,Mobile,Date,Item,Qty,Rate,Total,Status\n";

  const customers = await getDocs(collection(db,"users",UID,"customers"));

  for (const c of customers.docs) {
    const cust = c.data();
    const orders = await getDocs(
      collection(db,"users",UID,"orders",c.id,"items")
    );

    orders.forEach(o=>{
      const d = o.data();
      csv += `${cust.name},${cust.number},${d.date},${d.item},${d.qty},${d.rate},${d.total},${d.status}\n`;
    });
  }

  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download = "All_Customers_Report.csv";
  a.click();
};
</script>

<style>
body{margin:0;font-family:Segoe UI;background: linear-gradient(135deg,#04ba62,#c81d56);
  color:#0f172a;

  color:#1f2937;}
.container{max-width:1000px;margin:auto;background:#fff;padding:20px;border-radius:15px}

.headingBox{
background:linear-gradient(90deg,#eca20f,#212043,#2c5364);
  color:#ffffff;border:3px solid #ff9900;
display:flex;align-items:center;justify-content:center;gap:15px;
border-radius:12px;padding:15px
}
.headingBox img{width:150px;height:150px;border-radius:50%}
.headingBox h2{margin:0;font-size:32px; color:#f9fafb;}

input,select,button{
padding:10px;border-radius:8px;border:1px solid #ccc;margin:5px
}
button{background:#007bff;color:#fff}
button:hover{background:#0056b3}

.customerCard{
display:flex;justify-content:space-between;
background:#f1f5f9;padding:12px;border-radius:10px;margin:8px 0
}
.rightBtns button{margin-left:5px}

.hidden{display:none}

/* CUSTOMER OPEN BOX */
#customerSection{
margin-top:25px;
padding:20px;
border-radius:16px;
border:3px solid #007BFF;
background:linear-gradient(135deg,#f0f8ff,#ffffff);
box-shadow:0 10px 25px rgba(0,0,0,0.15);
}

#customerTitle{
text-align:center;
font-size:28px;
font-weight:800;
color:#0c0d0d;
margin-bottom:20px;
padding-bottom:10px;
border-bottom:2px dashed #007BFF;
}

table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#007bff;color:#fff}

.actionBox{
margin:15px 0;padding:15px;border-radius:12px;
display:flex;flex-wrap:wrap;gap:10px
}
.entryBox{background:#e8f4ff;border:2px solid #007bff}
.billBox{background:#fff3e0;border:2px solid #ff9800}

.totals{
display:flex;flex-wrap:wrap;gap:10px;justify-content:center
}
.totals div{
background:#f0f8ff;padding:10px 15px;border-radius:10px
}

@media(max-width:768px){
.customerCard{flex-direction:column}
input,select,button{width:100%}
}
/* CUSTOMER LIST ROW BIG & BOLD */
.customerCard{
  font-size: 18px;          /* size ‡§¨‡§°‡§º‡§æ */
  font-weight: 600;         /* bold */
  padding: 16px 18px;       /* ‡§•‡•ã‡§°‡§º‡§æ spacious */
}

/* CUSTOMER NAME EXTRA STRONG */
.customerCard span{
  font-size: 19px;
  font-weight: 700;         /* ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ bold */
  color:#0f172a;
}

/* MOBILE VIEW ME AUR BADA */
@media(max-width:768px){
  .customerCard{
    font-size: 17px;
  }
  .customerCard span{
    font-size: 18px;
  }
}
/* ===== BIG & CLEAN INPUT BOX ===== */
input, select{
  height: 40px;           /* ‡§ä‡§Å‡§ö‡§æ‡§à ‡§¨‡§¢‡§º‡•Ä */
  font-size: 16px;        /* text ‡§¨‡§°‡§º‡§æ */
  padding: 10px 14px;
  border-radius: 10px;
  border: 1.5px solid #cbd5e1;
  background:#ffffff;
  font-weight: bold;
}

/* PLACEHOLDER CLEAR */
input::placeholder{
  font-size: 15px;
  color:#64748b;
}

/* FOCUS EFFECT */
input:focus, select:focus{
  outline: none;
  border-color:#2563eb;
  box-shadow:0 0 0 3px rgba(37,99,235,0.2);
}

/* MOBILE ME AUR BADA */
@media(max-width:768px){
  input, select{
    height: 52px;
    font-size: 17px;
  }
}
.logout{
  position: fixed;
  top: 10px;
  right: 12px;
  margin: 15px;
  padding: 5px 14px;     /* ‡§õ‡•ã‡§ü‡§æ */
  font-size: 20px;
  font-weight: 600;
  border-radius: 18px;
  background:#961818;
  color:#121111;
  border: 2px solid greenyellow;
  cursor:pointer;
  z-index:9999;
}

.logout:hover{
  background:#084298;
}

/* Mobile */
@media(max-width:768px){
  .logout{
    width: 50%;
    top: 8px;
    right: 8px;
    margin: 20px;
    padding: 4px 12px;
    font-size: 12px;
  }
}
.excelAllBtn{
  background:#16a34a;
  color:#fff;
  font-size:16px;
  font-weight:700;
  padding:12px 18px;
  border-radius:10px;
  border:none;
  margin:10px 0;
  cursor:pointer;
}

/* MOBILE */
@media(max-width:768px){
  .excelAllBtn{
    width:100%;
    font-size:17px;
    padding:14px;
  }
}
</style>

<body>
<button  class="logout" onclick="logout()" >Logout</button>

<div class="container" id="mainPage" style="display:none">

<div class="headingBox">
<img src="kalyani.jpeg">
<h2>Kalyani food and catering services</h2>
</div>

<input id="searchInput" placeholder="üîç Search Customer" onkeyup="searchCustomer()">

<input id="custName" placeholder="Customer Name">
<input id="custNumber" placeholder="Mobile Number">
<button onclick="addCustomer()">Add Customer</button>

<div id="customerList"></div>

<div id="customerSection" class="hidden">
<button onclick="backToCustomers()">‚¨Ö Back</button>
<h3 id="customerTitle"></h3>

<div class="actionBox entryBox">
<input id="orderDate" readonly>
<select id="itemType">
<option value="tea">Tea</option>
<option value="snack">Snack</option>
<option value="lunch">Lunch</option>
<option value="dinner">Dinner</option>
<option value="other">Other</option>
</select>

<input id="otherName" placeholder="Item">
<input id="otherRate" placeholder="Rate">
<input id="qty" placeholder="Qty">

<select id="statusType">
<option value="due">Due</option>
<option value="paid">Paid</option>
<option value="parchi">Parchi</option>
</select>

<button onclick="addOrder()">Add Entry</button>
</div>

<div class="actionBox billBox">
<button onclick="printBill()">üßæ Print Bill</button>
<button onclick="downloadMonthlyCSV()">üì• Download Excel</button>
<button class="excelAllBtn" onclick="downloadAllCustomersExcel()">
  All Customers Excel
</button>
</div>

<table>
<thead>
<tr>
<th>Date</th><th>Item</th><th>Qty</th>
<th>Rate</th><th>Total</th><th>Status</th><th>X</th>
</tr>
</thead>
<tbody id="orderList"></tbody>
</table>

<div class="totals">
<div>Due ‚Çπ <span id="totalDue">0</span></div>
<div>Paid ‚Çπ <span id="totalPaid">0</span></div>
<div>Parchi ‚Çπ <span id="totalParchi">0</span></div>
<div>Grand ‚Çπ <span id="grandTotal">0</span></div>
</div>

</div>
</div>
</body>
</html>
